"""
A module for pipeline in the engineering package.
"""

import pandas as pd

from engineering.extraction.extraction import read_csv
from engineering.loading.loading import write_csv
from engineering.transformation.transformation import (
    clean_data,
    merge_datasets,
    transform_data,
    validate_data,
)
from schemas.cve_score import CVEScore
from schemas.malware_hash import MalwareHash

pd.set_option("display.max_columns", 50)


def etl_process(
    malware_file: str, cve_file: str, output_file: str
) -> pd.DataFrame:
    """
    Run the ETL process.
    :param malware_file: Path to the malware CSV file.
    :type malware_file: str
    :param cve_file: Path to the CVE CSV file.
    :type cve_file: str
    :param output_file: Path to the output CSV file.
    :type output_file: str
    :return: The combined dataframe with the whole data from CVE
    :rtype: pd.DataFrame
    """
    malware_df: pd.DataFrame = read_csv(malware_file)
    cve_df: pd.DataFrame = read_csv(cve_file)

    cleaned_malware_df: pd.DataFrame = clean_data(malware_df)
    validated_malware_df: pd.DataFrame = validate_data(
        cleaned_malware_df, MalwareHash
    )
    validated_cve_df: pd.DataFrame = validate_data(cve_df, CVEScore)
    transformed_malware_df: pd.DataFrame = transform_data(validated_malware_df)
    combined_df: pd.DataFrame = merge_datasets(
        transformed_malware_df, validated_cve_df, on="cveid"
    )

    write_csv(combined_df, output_file)
    return combined_df
